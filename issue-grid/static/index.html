
<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<script src="https://redom.js.org/redom.min.js"></script>
<script>

  function has_tunnel(obj /*, level1, level2, ... levelN*/) {
    var args = Array.prototype.slice.call(arguments, 1);

    for (var i = 0; i < args.length; i++) {
      if (!obj || !obj.hasOwnProperty(args[i])) {
        return false;
      }
      obj = obj[args[i]];
    }
    return true;
  }

  const { el, router, mount, text, list, setAttr, setStyle, place, } = redom;

  class Avatar {
    constructor(user) {
      this.el = el('img.user-icon');
      user && this.update(user);
    }

    update(user) {
      setAttr(this.el, { src: user.icon_url });
    }
  }

  class Label {
    constructor(label) {
      this.el = el('span.label');
      label && this.update(label);
    }

    update(label) {
      this.el.textContent = label.name;
      setStyle(this.el, { 'background-color': label.color });
    }
  }

  class Issue {
    constructor(issue) {
      this.labels = list('div.label-list', Label);
      this.creator = new Avatar();
      this.number = el('span.issue-number');
      this.title = el('span.issue-name');

      this.el = el('div.issue', [
        el('h4.issue-h4', [
          this.creator,
          this.number,
          text(' '),
          this.title,
        ]),

        this.labels,
      ]);

      issue && this.update(issue);
    }

    update(issue) {
      this.labels.update(issue.labels);
      this.creator.update(issue.creator);

      this.number.textContent = `#${issue.number}`;
      this.title.textContent = issue.title;
    }
  }

  class BinHeader {
    constructor(bin) {
      this.header = el('div.bin-header');
      this.el = place(this.header);
      bin && update(bin);
    }

    update(bin) {
      if (bin.name) {
        this.header.textContent = bin.name;
        if (bin.main_label) {
          setStyle(this.header, { 'background-color': bin.main_label.color });
        }

        this.el.update(true);
      } else {
        this.el.update(false);
      }
    }
  }

  class IssueBin {
    constructor(bin) {
      this.header = new BinHeader();
      this.issues = list('div', Issue);

      this.el = el('div.issue-bin', [
        this.header,
        this.issues,
      ]);

      bin && this.update(bin);
    }

    update(bin) {
      this.header.update(bin);
      this.issues.update(bin.issues);
    }
  }

  class IssueGrid {
    constructor(bins) {
      this.bins = list('div.issue-grid', IssueBin);
      this.el = this.bins;
      bins && this.update(bins);
    }

    update(bins) {
      this.bins.update(bins);
    }
  }

  function main() {
    fetch('/api/bin_issues?remove_main_labels=true')
      .then(resp => resp.json())
      .then(data => {
        let grid = new IssueGrid(data);
        mount(document.body, grid);
      });
  }
  main();

</script>

</body>
</html>