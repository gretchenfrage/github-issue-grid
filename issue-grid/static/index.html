
<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<script src="https://redom.js.org/redom.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>

  function has_tunnel(obj /*, level1, level2, ... levelN*/) {
    var args = Array.prototype.slice.call(arguments, 1);

    for (var i = 0; i < args.length; i++) {
      if (!obj || !obj.hasOwnProperty(args[i])) {
        return false;
      }
      obj = obj[args[i]];
    }
    return true;
  }

  const { el, router, mount, text, list, setAttr, setStyle, place, } = redom;

  class Avatar {
    constructor(user) {
      this.el = el('div.user-icon.has-tooltip', [
        (this.icon_link = el(
          'a', (this.icon = el('img.user-icon'))
        )),
        (this.tooltip = el(
          'div.user-icon-tooltip', (this.tooltip_link = el('a')))
        ),
      ]);

      let state = { epoch: 0, delay: 85, tooltip: this.tooltip };
      $(this.el).hover(() => {
        // on hover
        setStyle(state.tooltip, { visibility: 'visible' });
        state.epoch++;
      }, () => {
        // on de-hover
        let epoch = ++state.epoch;
        window.setTimeout(() => {
          if (state.epoch === epoch) {
            setStyle(state.tooltip, { visibility: 'hidden' })
          }
        }, state.delay);
      });

      user && this.update(user);
    }

    update(user) {
      setAttr(this.icon, { src: user.icon_url });
      setAttr(this.icon_link, { href: user.hyperlink });
      setAttr(this.tooltip_link, { href: user.hyperlink });
      console.log(`user name = ${user.name}`);
      this.tooltip_link.innerText = user.name;
    }
  }

  class Label {
    constructor(label) {
      this.el = el('span.label');
      label && this.update(label);
    }

    update(label) {
      this.el.textContent = label.name;
      setStyle(this.el, { 'background-color': label.color });
    }
  }

  class Issue {
    constructor(issue) {
      this.labels = list('div.label-list', Label);
      this.creator = new Avatar();
      this.number = el('span.issue-number');
      this.title = el('span.issue-name');

      this.el = el('div.issue', [
        el('h4.issue-h4', [
          this.creator,
          (this.issue_link = el('a', [
            this.number,
            text(' '),
            this.title,
          ]))
        ]),

        this.labels,
      ]);

      issue && this.update(issue);
    }

    update(issue) {
      this.labels.update(issue.labels);
      this.creator.update(issue.creator);

      this.number.textContent = `#${issue.number}`;
      this.title.textContent = issue.title;

      setAttr(this.issue_link, { href: issue.hyperlink });
    }
  }

  class BinHeader {
    constructor(bin) {
      this.header = el('div.bin-header');
      this.el = place(this.header);
      bin && update(bin);
    }

    update(bin) {
      if (bin.name) {
        this.header.textContent = bin.name;
        if (bin.main_label) {
          setStyle(this.header, { 'background-color': bin.main_label.color });
        }

        this.el.update(true);
      } else {
        this.el.update(false);
      }
    }
  }

  class IssueBin {
    constructor(bin) {
      this.header = new BinHeader();
      this.issues = list('div', Issue);

      this.el = el('div.issue-bin', [
        this.header,
        this.issues,
      ]);

      bin && this.update(bin);
    }

    update(bin) {
      this.header.update(bin);
      this.issues.update(bin.issues);
    }
  }

  class IssueGrid {
    constructor(bins) {
      this.bins = list('div.issue-grid', IssueBin);
      this.el = this.bins;
      bins && this.update(bins);
    }

    update(bins) {
      console.log(bins);
      this.bins.update(bins);
    }
  }

  class PageHeader {
    constructor(repo) {
      this.repo_name = el('a.repo-name');
      this.el = el('div.header-box', [
        this.repo_name,
      ]);

      repo && this.update(repo);
    }

    update(repo) {
      this.repo_name.textContent = repo.repo_name;
      setAttr(this.repo_name, { href: repo.repo_hyperlink });
    }
  }

  class App {
    constructor(state) {
      this.grid = new IssueGrid();
      this.header = new PageHeader();

      this.el = el('div.wh100', [
        this.header,
        el('div.grid-box', this.grid),
      ]);

      state && this.update(state);
    }

    update(state) {
      this.header.update(state.repo);
      this.grid.update(state.bins);
    }
  }

  function main() {
    function resp_json(resp) {
      return resp.json();
    }

    Promise.all([
      fetch('/api/repo_name').then(resp_json),
      fetch('/api/repo_hyperlink').then(resp_json),
      fetch('/api/list_profiles').then(resp_json),
    ]).then(values => {
      return {
        repo_name: values[0],
        repo_hyperlink: values[1],
        profiles: values[2],
      };
    }).then(repo => {
      let profile = encodeURI(repo.profiles[0].name);

      return fetch(`/api/${profile}/bin_issues?remove_main_labels=true`)
        .then(resp_json)
        .then(bins => {
          return {
            repo: repo,
            bins: bins,
          };
        });
    }).then(state => {
      mount(document.body, new App(state));
    });

    /*
    fetch('/api/bin_issues?remove_main_labels=true')
      .then(resp => resp.json())
      .then(data => {
        mount(document.body, new App(data));
      });
     */
  }
  main();

</script>

</body>
</html>