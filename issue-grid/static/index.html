
<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<script src="https://redom.js.org/redom.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>

  function css_to_8rgb(input) {
    var mm;
    var m;
    // Obviously, the numeric values will be easier to parse than names.So we do those first.
    mm = input.match(/^#?([0-9a-f]{3})$/i);
    if (mm) {
      m = mm[1];
      // in three-character format, each value is multiplied by 0x11 to give an
      // even scale from 0x00 to 0xff
      return [
        parseInt(m.charAt(0), 16) * 0x11,
        parseInt(m.charAt(1), 16) * 0x11,
        parseInt(m.charAt(2), 16) * 0x11
      ];
    }
    // That's one. Now for the full six-digit format:
    mm = input.match(/^#?([0-9a-f]{6})$/i);
    if (mm) {
      m = mm[1];
      return [
        parseInt(m.substr(0, 2), 16),
        parseInt(m.substr(2, 2), 16),
        parseInt(m.substr(4, 2), 16)
      ];
    }
    // And now for rgb() format:
    var mm = input.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);
    if (mm) {
      return [mm[1], mm[2], mm[3]];
    }
    // https://www.w3schools.com/colors/colors_names.asp
    // https://en.wikipedia.org/wiki/Web_colors
    // http://www.colors.commutercreative.com/grid/
    var webColors = {
      "AliceBlue": "#F0F8FF",
      "AntiqueWhite": "#FAEBD7",
      "Aqua": "#00FFFF",
      "Aquamarine": "#7FFFD4",
      "Azure": "#F0FFFF",
      "Beige": "#F5F5DC",
      "Bisque": "#FFE4C4",
      "Black": "#000000",
      "BlanchedAlmond": "#FFEBCD",
      "Blue": "#0000FF",
      "BlueViolet": "#8A2BE2",
      "Brown": "#A52A2A",
      "BurlyWood": "#DEB887",
      "CadetBlue": "#5F9EA0",
      "Chartreuse": "#7FFF00",
      "Chocolate": "#D2691E",
      "Coral": "#FF7F50",
      "CornflowerBlue": "#6495ED",
      "Cornsilk": "#FFF8DC",
      "Crimson": "#DC143C",
      "Cyan": "#00FFFF",
      "DarkBlue": "#00008B",
      "DarkCyan": "#008B8B",
      "DarkGoldenRod": "#B8860B",
      "DarkGray": "#A9A9A9",
      "DarkGrey": "#A9A9A9",
      "DarkGreen": "#006400",
      "DarkKhaki": "#BDB76B",
      "DarkMagenta": "#8B008B",
      "DarkOliveGreen": "#556B2F",
      "DarkOrange": "#FF8C00",
      "DarkOrchid": "#9932CC",
      "DarkRed": "#8B0000",
      "DarkSalmon": "#E9967A",
      "DarkSeaGreen": "#8FBC8F",
      "DarkSlateBlue": "#483D8B",
      "DarkSlateGray": "#2F4F4F",
      "DarkSlateGrey": "#2F4F4F",
      "DarkTurquoise": "#00CED1",
      "DarkViolet": "#9400D3",
      "DeepPink": "#FF1493",
      "DeepSkyBlue": "#00BFFF",
      "DimGray": "#696969",
      "DimGrey": "#696969",
      "DodgerBlue": "#1E90FF",
      "FireBrick": "#B22222",
      "FloralWhite": "#FFFAF0",
      "ForestGreen": "#228B22",
      "Fuchsia": "#FF00FF",
      "Gainsboro": "#DCDCDC",
      "GhostWhite": "#F8F8FF",
      "Gold": "#FFD700",
      "GoldenRod": "#DAA520",
      "Gray": "#808080",
      "Grey": "#808080",
      "Green": "#008000",
      "GreenYellow": "#ADFF2F",
      "HoneyDew": "#F0FFF0",
      "HotPink": "#FF69B4",
      "IndianRed ": "#CD5C5C",
      "Indigo ": "#4B0082",
      "Ivory": "#FFFFF0",
      "Khaki": "#F0E68C",
      "Lavender": "#E6E6FA",
      "LavenderBlush": "#FFF0F5",
      "LawnGreen": "#7CFC00",
      "LemonChiffon": "#FFFACD",
      "LightBlue": "#ADD8E6",
      "LightCoral": "#F08080",
      "LightCyan": "#E0FFFF",
      "LightGoldenRodYellow": "#FAFAD2",
      "LightGray": "#D3D3D3",
      "LightGrey": "#D3D3D3",
      "LightGreen": "#90EE90",
      "LightPink": "#FFB6C1",
      "LightSalmon": "#FFA07A",
      "LightSeaGreen": "#20B2AA",
      "LightSkyBlue": "#87CEFA",
      "LightSlateGray": "#778899",
      "LightSlateGrey": "#778899",
      "LightSteelBlue": "#B0C4DE",
      "LightYellow": "#FFFFE0",
      "Lime": "#00FF00",
      "LimeGreen": "#32CD32",
      "Linen": "#FAF0E6",
      "Magenta": "#FF00FF",
      "Maroon": "#800000",
      "MediumAquaMarine": "#66CDAA",
      "MediumBlue": "#0000CD",
      "MediumOrchid": "#BA55D3",
      "MediumPurple": "#9370DB",
      "MediumSeaGreen": "#3CB371",
      "MediumSlateBlue": "#7B68EE",
      "MediumSpringGreen": "#00FA9A",
      "MediumTurquoise": "#48D1CC",
      "MediumVioletRed": "#C71585",
      "MidnightBlue": "#191970",
      "MintCream": "#F5FFFA",
      "MistyRose": "#FFE4E1",
      "Moccasin": "#FFE4B5",
      "NavajoWhite": "#FFDEAD",
      "Navy": "#000080",
      "OldLace": "#FDF5E6",
      "Olive": "#808000",
      "OliveDrab": "#6B8E23",
      "Orange": "#FFA500",
      "OrangeRed": "#FF4500",
      "Orchid": "#DA70D6",
      "PaleGoldenRod": "#EEE8AA",
      "PaleGreen": "#98FB98",
      "PaleTurquoise": "#AFEEEE",
      "PaleVioletRed": "#DB7093",
      "PapayaWhip": "#FFEFD5",
      "PeachPuff": "#FFDAB9",
      "Peru": "#CD853F",
      "Pink": "#FFC0CB",
      "Plum": "#DDA0DD",
      "PowderBlue": "#B0E0E6",
      "Purple": "#800080",
      "RebeccaPurple": "#663399",
      "Red": "#FF0000",
      "RosyBrown": "#BC8F8F",
      "RoyalBlue": "#4169E1",
      "SaddleBrown": "#8B4513",
      "Salmon": "#FA8072",
      "SandyBrown": "#F4A460",
      "SeaGreen": "#2E8B57",
      "SeaShell": "#FFF5EE",
      "Sienna": "#A0522D",
      "Silver": "#C0C0C0",
      "SkyBlue": "#87CEEB",
      "SlateBlue": "#6A5ACD",
      "SlateGray": "#708090",
      "SlateGrey": "#708090",
      "Snow": "#FFFAFA",
      "SpringGreen": "#00FF7F",
      "SteelBlue": "#4682B4",
      "Tan": "#D2B48C",
      "Teal": "#008080",
      "Thistle": "#D8BFD8",
      "Tomato": "#FF6347",
      "Turquoise": "#40E0D0",
      "Violet": "#EE82EE",
      "Wheat": "#F5DEB3",
      "White": "#FFFFFF",
      "WhiteSmoke": "#F5F5F5",
      "Yellow": "#FFFF00",
      "YellowGreen": "#9ACD32"
    };
    for (var p in webColors) {
      webColors[p.toLowerCase()] = webColors[p];
    }
    var wc = webColors[input];
    if (wc != null)
      return parseColor(wc);
    console.log(input);
    throw Error("'" + input + "' is not a valid color...");
  }

  function luminance(srgb) {
    // see: https://www.w3.org/TR/WCAG20-TECHS/G17.html

    function f(n) {
      return n <= 0.03928 ?
        (n / 12.92):
        (((n + 0.055) / 1.055) ** 2.4);
    }

    return 0.2126 * f(srgb[0]) + 0.7152 * f(srgb[1]) + 0.0722 * f(srgb[2]);
  }

  function _8rgb_to_srgb(_8rgb) {
    return [_8rgb[0] / 255, _8rgb[1] / 255, _8rgb[2] / 255];
  }

  function contrast(srgb1, srgb2) {
    let l1 = luminance(srgb1);
    let l2 = luminance(srgb2);
    if (l1 < l2) {
      let temp = l1;
      l1 = l2;
      l2 = temp;
    }
    return (l1 + 0.05) / (l2 + 0.05);
  }

  function max_contrast_css(css_color) {
    let fg = css_to_8rgb(css_color);
    fg = !fg || _8rgb_to_srgb(fg);

    let bg1 = [0, 0, 0];
    let bg2 = [1, 1, 1];

    let bg;
    if (!fg) {
      bg = bg1;
    } else if (contrast(fg, bg1) >= contrast(fg, bg2)) {
      bg = bg1;
    } else {
      bg = bg2;
    }

    return `rgb(${bg[0] * 255}, ${bg[1] * 255}, ${bg[2] * 255})`;
  }

  function has_tunnel(obj /*, level1, level2, ... levelN*/) {
    var args = Array.prototype.slice.call(arguments, 1);

    for (var i = 0; i < args.length; i++) {
      if (!obj || !obj.hasOwnProperty(args[i])) {
        return false;
      }
      obj = obj[args[i]];
    }
    return true;
  }

  const { el, router, mount, text, list, setAttr, setStyle, place, } = redom;

  class Avatar {
    constructor(user) {
      this.el = el('div.user-icon.has-tooltip', [
        (this.icon_link = el(
          'a', (this.icon = el('img.user-icon'))
        )),
        (this.tooltip = el(
          'div.user-icon-tooltip', (this.tooltip_link = el('a')))
        ),
      ]);

      let state = { epoch: 0, delay: 85, tooltip: this.tooltip };
      $(this.el).hover(() => {
        // on hover
        setStyle(state.tooltip, { visibility: 'visible' });
        state.epoch++;
      }, () => {
        // on de-hover
        let epoch = ++state.epoch;
        window.setTimeout(() => {
          if (state.epoch === epoch) {
            setStyle(state.tooltip, { visibility: 'hidden' })
          }
        }, state.delay);
      });

      user && this.update(user);
    }

    update(user) {
      setAttr(this.icon, { src: user.icon_url });
      setAttr(this.icon_link, { href: user.hyperlink });
      setAttr(this.tooltip_link, { href: user.hyperlink });
      this.tooltip_link.innerText = user.name;
    }
  }

  class Label {
    constructor(label) {
      this.el = el('span.label');
      label && this.update(label);
    }

    update(label) {
      this.el.textContent = label.name;
      setStyle(this.el, { 'background-color': label.color });
      setStyle(this.el, { 'color': max_contrast_css(label.color) });
    }
  }

  class Issue {
    constructor(issue) {
      this.labels = list('div.label-list', Label);
      this.creator = new Avatar();
      this.number = el('span.issue-number');
      this.title = el('span.issue-name');

      this.el = el('div.issue', [
        el('h4.issue-h4', [
          this.creator,
          (this.issue_link = el('a', [
            this.number,
            text(' '),
            this.title,
          ]))
        ]),

        this.labels,
      ]);

      issue && this.update(issue);
    }

    update(issue) {
      this.labels.update(issue.labels);
      this.creator.update(issue.creator);

      this.number.textContent = `#${issue.number}`;
      this.title.textContent = issue.title;

      setAttr(this.issue_link, { href: issue.hyperlink });
    }
  }

  class BinHeader {
    constructor(bin) {
      this.header = el('div.bin-header');
      this.el = place(this.header);
      bin && update(bin);
    }

    update(bin) {
      if (bin.name) {
        this.header.textContent = bin.name;
        if (bin.main_label) {
          setStyle(this.header, { 'background-color': bin.main_label.color });
        }

        this.el.update(true);
      } else {
        this.el.update(false);
      }
    }
  }

  class IssueBin {
    constructor(bin) {
      this.header = new BinHeader();
      this.issues = list('div', Issue);

      this.el = el('div.issue-bin', [
        this.header,
        this.issues,
      ]);

      bin && this.update(bin);
    }

    update(bin) {
      this.header.update(bin);
      this.issues.update(bin.issues);
    }
  }

  class IssueGrid {
    constructor(bins) {
      this.bins = list('div.issue-grid', IssueBin);
      this.el = this.bins;
      bins && this.update(bins);
    }

    update(bins) {
      console.log(bins);
      this.bins.update(bins);
    }
  }

  class ProfileOption {
    constructor(profile) {
      this.el = el('option');

      profile && this.update(profile);
    }

    update(profile) {
      this.el.textContent = profile.name;
      setAttr(this.el, { val: profile.name });
    }
  }

  class RevalidateButton {
    constructor(callback) {
      this.el = el('button.revalidate-button', 'revalidate');

      $(this.el).click(() => this.on_click());

      callback && this.update(callback);
    }

    update(callback) {
      setAttr(this.el, { className: 'revalidate-button' });
      this.callback = callback;
    }

    on_click() {
      setAttr(this.el, { className: 'revalidate-button revalidate-button-red' });
      this.callback();
    }
  }

  class PageHeader {
    constructor(state) {
      this.repo_name = el('a.repo-name');
      this.revalidate_button = new RevalidateButton();
      this.profile_select = list('select.profile-select', ProfileOption);

      this.el = el('div.header-box', [
        this.repo_name,
        this.profile_select,
        this.revalidate_button,
      ]);

      $(this.profile_select.el).change(() => this.on_change());

      state && this.update(state);
    }

    update(state) {
      this.repo_name.textContent = state.repo.repo_name;
      setAttr(this.repo_name, { href: state.repo.repo_hyperlink });
      this.profile_select.update(state.repo.profiles);
      this.revalidate_button.update(() => this.revalidate());

      this.active_profile = state.active_profile;
      this.profile_callback = state.profile_callback;

    }

    on_change() {
      let choice = $(this.profile_select.el).find(":selected").val();
      this.profile_callback(choice);
    }

    revalidate() {
      this.profile_callback(this.active_profile, true);
    }
  }

  class App {
    constructor(state) {
      this.grid = new IssueGrid();
      this.header = new PageHeader();

      this.el = el('div.wh100', [
        this.header,
        el('div.grid-box', this.grid),
      ]);

      state && this.update(state);
    }

    update(state) {
      this.grid.update(state.bins);
      this.header.update(state);
    }
  }

  function main() {
    function resp_json(resp) {
      return resp.json();
    }

    Promise.all([
      fetch('/api/repo_name').then(resp_json),
      fetch('/api/repo_hyperlink').then(resp_json),
      fetch('/api/list_profiles').then(resp_json),
    ]).then(values => {
      return {
        repo_name: values[0],
        repo_hyperlink: values[1],
        profiles: values[2],
      };
    }).then(repo => {
      let app = new App();

      function set_profile(profile, revalidate) {
        return fetch(`/api/${encodeURI(profile)}/bin_issues?remove_main_labels=true&revalidate=${!!revalidate}`)
          .then(resp_json)
          .then(bins => {
            let state = {
              repo: repo,
              bins: bins,
              active_profile: profile,
              profile_callback: set_profile,
            };

            app.update(state);
          });
      }

      set_profile(repo.profiles[0].name)
        .then(() => {
          mount(document.body, app);
        })


      /*
      return fetch(`/api/${profile}/bin_issues?remove_main_labels=true`)
        .then(resp_json)
        .then(bins => {
          return {
            repo: repo,
            bins: bins,
          };
        });
        */
    });

    /*
    fetch('/api/bin_issues?remove_main_labels=true')
      .then(resp => resp.json())
      .then(data => {
        mount(document.body, new App(data));
      });
     */
  }
  main();

</script>

</body>
</html>